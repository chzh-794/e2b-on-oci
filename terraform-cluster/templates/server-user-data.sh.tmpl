#!/bin/bash

set -euo pipefail

exec > >(tee /var/log/e2b-server-user-data.log | logger -t e2b-server-user-data -s 2>/dev/console) 2>&1

echo "================================================================================"
echo "E2B Server Cluster Bootstrap"
echo "Environment: ${environment}"
echo "Prefix: ${prefix}"
echo "Compartment: ${compartment_id}"
echo "Region: ${region}"
echo "================================================================================"

# Wait for apt locks to be released (cloud-init may be running other apt operations)
while sudo fuser /var/lib/apt/lists/lock >/dev/null 2>&1; do sleep 2; done
while sudo fuser /var/lib/dpkg/lock-frontend >/dev/null 2>&1; do sleep 2; done
while sudo fuser /var/lib/dpkg/lock >/dev/null 2>&1; do sleep 2; done

sudo apt-get update -y
sudo apt-get install -y python3-pip jq gzip
pip3 install --upgrade oci-cli
export PATH="$PATH:/usr/local/bin"

cat <<'EOF' >/etc/profile.d/e2b-server-env.sh
export E2B_ENVIRONMENT="${environment}"
export E2B_PREFIX="${prefix}"
export E2B_REGION="${region}"
export E2B_COMPARTMENT_ID="${compartment_id}"
export CONSUL_GOSSIP_ENCRYPTION_KEY="${consul_gossip_encryption_key}"
EOF

chmod +x /etc/profile.d/e2b-server-env.sh

export OCI_CLI_AUTH=instance_principal

sudo modprobe -r nbd || true
sudo modprobe nbd max_part=16 nbds_max=128
sudo sysctl -w kernel.unprivileged_userns_clone=1

sudo mkdir -p /opt/consul/bin /opt/nomad/bin /opt/e2b/runtime /orchestrator
sudo chmod 0755 /opt/consul /opt/nomad /opt/e2b /opt/e2b/runtime /orchestrator

echo "${consul_run_script_b64}" | base64 --decode | gunzip >/opt/consul/bin/run-consul.sh
echo "${nomad_run_script_b64}" | base64 --decode | gunzip >/opt/nomad/bin/run-nomad.sh

chmod +x /opt/consul/bin/run-consul.sh /opt/nomad/bin/run-nomad.sh

# Flush host firewall to allow intra-cluster communication
if command -v iptables >/dev/null 2>&1; then
  sudo iptables -F INPUT || true
  sudo iptables -P INPUT ACCEPT || true
  sudo iptables -F FORWARD || true
  sudo iptables -P FORWARD ACCEPT || true
fi

# Flush Docker iptables chains to allow intra-cluster networking
if command -v iptables >/dev/null 2>&1; then
  sudo iptables -F DOCKER || true
  sudo iptables -F DOCKER-FORWARD || true
  sudo iptables -F DOCKER-USER || true
  sudo iptables -F DOCKER-ISOLATION-STAGE-1 || true
  sudo iptables -F DOCKER-ISOLATION-STAGE-2 || true
fi

%{ if auto_bootstrap }
/opt/consul/bin/run-consul.sh \
  --gossip-encryption-key "${consul_gossip_encryption_key}" \
  --cluster-size "${cluster_size}" \
  --compartment-id "${compartment_id}" \
  --cluster-role "server" \
  --region "${region}"

/opt/nomad/bin/run-nomad.sh \
  --cluster-size "${cluster_size}" \
  --compartment-id "${compartment_id}" \
  --cluster-role "server" \
  --region "${region}"
%{ else }
echo "Auto bootstrap disabled by configuration; Consul/Nomad startup skipped."
%{ endif }

echo "E2B server bootstrap completed."

