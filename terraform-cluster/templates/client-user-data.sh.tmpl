#!/bin/bash

set -euo pipefail

exec > >(tee /var/log/e2b-client-user-data.log | logger -t e2b-client-user-data -s 2>/dev/console) 2>&1

echo "================================================================================"
echo "E2B Client Pool Bootstrap"
echo "Environment: ${environment}"
echo "Prefix: ${prefix}"
echo "Compartment: ${compartment_id}"
echo "Region: ${region}"
echo "================================================================================"

sudo apt-get update -y
sudo apt-get install -y python3-pip jq gzip nfs-common nftables nbd-client
pip3 install --upgrade oci-cli
export PATH="$PATH:/usr/local/bin"
sudo systemctl stop docker docker.socket >/dev/null 2>&1 || true
sudo apt remove -y docker-ce docker-ce-cli docker-buildx-plugin docker-compose-plugin containerd containerd.io >/dev/null 2>&1 || true
sudo DEBIAN_FRONTEND=noninteractive apt install -y docker.io
sudo systemctl daemon-reload
sudo systemctl enable --now docker.socket
sudo systemctl restart docker || sudo systemctl start docker
sudo usermod -aG docker ubuntu || true

cat <<'EOF' >/etc/profile.d/e2b-client-env.sh
export E2B_ENVIRONMENT="${environment}"
export E2B_PREFIX="${prefix}"
export E2B_REGION="${region}"
export E2B_COMPARTMENT_ID="${compartment_id}"
export CONSUL_GOSSIP_ENCRYPTION_KEY="${consul_gossip_encryption_key}"
EOF

chmod +x /etc/profile.d/e2b-client-env.sh

export OCI_CLI_AUTH=instance_principal

sudo modprobe -r nbd || true
sudo modprobe nbd max_part=16 nbds_max=128
sudo sysctl -w kernel.unprivileged_userns_clone=1

sudo mkdir -p /opt/consul/bin /opt/nomad/bin /opt/e2b/runtime /orchestrator /var/e2b/templates /fc-envd /fc-kernels /fc-versions /mnt/disks/fc-envs/v1
sudo chmod 0755 /opt/consul /opt/nomad /opt/e2b /opt/e2b/runtime /orchestrator
sudo chown -R ubuntu:ubuntu /var/e2b /fc-envd /mnt/disks/fc-envs

sudo tee /usr/local/bin/e2b-cleanup-network.sh >/dev/null <<'EOF'
#!/usr/bin/env bash
set -euo pipefail

cleanup_namespaces() {
  mapfile -t namespaces < <(ip netns list 2>/dev/null | awk '{print $1}')
  for ns in "$${namespaces[@]}"; do
    [[ "$${ns}" == ns-* ]] || continue

    if [[ -n "$(ip netns pids "$${ns}" 2>/dev/null)" ]]; then
      continue
    fi

    idx="$${ns#ns-}"
    ip link delete "veth-$${idx}" >/dev/null 2>&1 || true
    ip netns delete "$${ns}" >/dev/null 2>&1 || true
  done
}

cleanup_nbd() {
  shopt -s nullglob
  for pid_file in /sys/block/nbd*/pid; do
    dev="$(basename "$(dirname "$${pid_file}")")"
    pid="$(cat "$${pid_file}")"

    if [[ "$${pid}" -eq 0 ]]; then
      nbd-client -d "/dev/$${dev}" >/dev/null 2>&1 || true
      continue
    fi

    if ! ps -p "$${pid}" >/dev/null 2>&1; then
      nbd-client -d "/dev/$${dev}" >/dev/null 2>&1 || true
    fi
  done
}

cleanup_namespaces
cleanup_nbd
EOF

sudo chmod +x /usr/local/bin/e2b-cleanup-network.sh

sudo tee /etc/systemd/system/e2b-cleanup-network.service >/dev/null <<'EOF'
[Unit]
Description=Cleanup stale E2B network namespaces and NBD devices
After=network.target

[Service]
Type=oneshot
ExecStart=/usr/local/bin/e2b-cleanup-network.sh
EOF

sudo tee /etc/systemd/system/e2b-cleanup-network.timer >/dev/null <<'EOF'
[Unit]
Description=Run E2B network cleanup periodically

[Timer]
OnBootSec=2min
OnUnitActiveSec=1min
AccuracySec=30s
Persistent=true

[Install]
WantedBy=timers.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable --now e2b-cleanup-network.timer

echo "${consul_run_script_b64}" | base64 --decode | gunzip >/opt/consul/bin/run-consul.sh
echo "${consul_client_run_script_b64}" | base64 --decode | gunzip >/opt/consul/bin/run-consul-client.sh
echo "${nomad_run_script_b64}" | base64 --decode | gunzip >/opt/nomad/bin/run-nomad.sh
echo "${nomad_client_run_script_b64}" | base64 --decode | gunzip >/opt/nomad/bin/run-nomad-client.sh

chmod +x /opt/consul/bin/run-consul.sh /opt/consul/bin/run-consul-client.sh /opt/nomad/bin/run-nomad.sh /opt/nomad/bin/run-nomad-client.sh

WAN_IF=$(ip route get 8.8.8.8 | awk '{for(i=1;i<=NF;i++) if($i=="dev") {print $(i+1); exit}}')

# Enable IPv4 forwarding so Firecracker guests can reach the internet.
sudo sysctl -w net.ipv4.ip_forward=1
echo "net.ipv4.ip_forward = 1" | sudo tee /etc/sysctl.d/99-e2b-ipforward.conf >/dev/null

if command -v nft >/dev/null 2>&1 && [ -n "$${WAN_IF}" ]; then
  sudo mkdir -p /etc/nftables.d
  sudo bash -c "cat <<EOF >/etc/nftables.d/e2b.nft
 flush table inet e2b
 table inet e2b {
   chain postrouting {
     type nat hook postrouting priority srcnat;
     policy accept;
     oifname \"$${WAN_IF}\" ip saddr 169.254.0.0/16 counter masquerade
     oifname \"$${WAN_IF}\" ip saddr 10.12.0.0/16 counter masquerade
   }

   chain forward {
     type filter hook forward priority filter;
     policy accept;
     iifname \"$${WAN_IF}\" oifname \"veth*\" ct state related,established counter accept
     iifname \"veth*\" oifname \"$${WAN_IF}\" counter accept
     iifname \"$${WAN_IF}\" oifname \"tap0\" ct state related,established counter accept
     iifname \"tap0\" oifname \"$${WAN_IF}\" counter accept
   }
 }
EOF"

  if ! sudo grep -q '/etc/nftables.d/*.nft' /etc/nftables.conf 2>/dev/null; then
    sudo bash -c "echo 'include \"/etc/nftables.d/*.nft\"' >>/etc/nftables.conf"
  fi

  sudo nft delete table inet e2b >/dev/null 2>&1 || true
  sudo nft -f /etc/nftables.d/e2b.nft
  sudo systemctl enable --now nftables || true
elif command -v iptables >/dev/null 2>&1; then
  sudo iptables -F INPUT || true
  sudo iptables -P INPUT ACCEPT || true
  sudo iptables -F FORWARD || true
  sudo iptables -P FORWARD ACCEPT || true

  if [ -n "$${WAN_IF}" ]; then
    sudo iptables -t nat -A POSTROUTING -s 169.254.0.0/16 -o "$${WAN_IF}" -j MASQUERADE
    sudo iptables -t nat -A POSTROUTING -s 10.12.0.0/16 -o "$${WAN_IF}" -j MASQUERADE
    sudo iptables -I FORWARD 1 -i "$${WAN_IF}" -o veth+ -m state --state RELATED,ESTABLISHED -j ACCEPT || true
    sudo iptables -I FORWARD 1 -i veth+ -o "$${WAN_IF}" -j ACCEPT || true
  fi
fi

/opt/consul/bin/run-consul-client.sh \
  --gossip-encryption-key "${consul_gossip_encryption_key}" \
  --compartment-id "${compartment_id}" \
  --region "${region}" \
  --server-role "server"

/opt/nomad/bin/run-nomad-client.sh \
  --compartment-id "${compartment_id}" \
  --region "${region}" \
  --node-class "client" \
  --meta "pool = \"client\"" \
  --server-role "server" \
  --host-volume "/var/e2b/templates" \
  --host-volume-name "e2b-templates"

echo "Running initial network/NBD cleanup to seed slot pool..."
sudo /usr/local/bin/e2b-cleanup-network.sh || true

echo "E2B client pool bootstrap completed."
